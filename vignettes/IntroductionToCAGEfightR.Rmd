---
title: "Introduction to CAGEfightR"
author: "Malte Thodberg"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Quick start for the impatient

Start by installing and/or loading the CAGEfightR library:

```{r loading_library, results="hide", warning=FALSE}
library(CAGEfightR)
```

## Setting up BigWig-files

A CAGEfightR anaysis usually starts with loading CAGE Transcript Start Sites from BigWig-files (one for each strand):

```{r BigWig_files, results="hide"}
# Load the example data
data("exampleDesign")
head(exampleDesign)

# Locate files on your harddrive
bw_plus <- system.file("extdata", exampleDesign$BigWigPlus, package = "CAGEfightR")
bw_minus <- system.file("extdata", exampleDesign$BigWigMinus, package = "CAGEfightR")

# Create two named BigWigFileList-objects:
bw_plus <- BigWigFileList(bw_plus)
bw_minus <- BigWigFileList(bw_minus)
names(bw_plus) <- exampleDesign$Name
names(bw_minus) <- exampleDesign$Name
```

## Finding TSSs

The wrapper function `quickTSSs` will automatically find and quantify TSSs, returning the results as a `RangedSummarizedExperiment`:
```{r quickTSSs, results="hide"}
TSSs <- quickTSSs(design=exampleDesign, bwPlus=bw_plus, bwMinus=bw_minus)
```

## Finding enhancers

Similary, `quickEnhancers` will find and quantify enhancers:
```{r, quickEnhancers, results="hide"}
enhancers <- quickEnhancers(design=exampleDesign, bwPlus=bw_plus, bwMinus=bw_minus)
```

## Find and annotate TSSs and enhancers

TSSs and enhancers are both found using overall coverage of CTSS. For a quicker analysis, the CTSS data and CTSS coverage can be loaded seperately:
```{r running_both, results="hide"}
# Load CTSS data
CTSS <- readCTSS(bwPlus=bw_plus, bwMinus=bw_minus)

# Coverage
CTSScoverage <- coverageOfCTSS(CTSS)

# TSSs
TSSs <- quickTSSs(design=exampleDesign, ctss=CTSS, ctssCoverage=CTSScoverage)

# Enhancers
enhancers <- quickEnhancers(design=exampleDesign, ctss=CTSS, ctssCoverage=CTSScoverage)
```

We can then use transcript models stored in a `TxDb`-object to annotate each TSSs and enhancer with their transcript context:

```{r txdb_annotation, results="hide"}
# Load the TxDb
library(TxDb.Mmusculus.UCSC.mm9.knownGene)
txdb <- TxDb.Mmusculus.UCSC.mm9.knownGene

# Annotate
rowRanges(TSSs)$txType <- assignTxType(gr=rowRanges(TSSs), txdb=txdb)
rowRanges(enhancers)$txType <- assignTxType(gr=rowRanges(enhancers), txdb=txdb)
```

Before merging TSSs and enhancers, we remove enhancers that overlap any known transcripts:
```{r subsetting, results="hide"}
# Subset
enhancers <- subset(enhancers, txType %in% c("intergenic", "intron"))
```

Finally, we can combine TSSs and enhancers. In case of any overlaps, we keep only enhancers:
```{r merging, results="hide"}
# Stack
rowRanges(TSSs)$RNA <- "mRNA"
rowRanges(enhancers)$RNA <- "eRNA"

CAGE <- stackRSEs(a=TSSs, b=enhancers, removeIfOverlapping = "a")
```


